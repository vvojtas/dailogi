create table app_user (id bigint generated by default as identity, created_at TIMESTAMP WITH TIME ZONE not null, email varchar(255) not null, is_special_user boolean not null, password_hash TEXT not null, updated_at TIMESTAMP WITH TIME ZONE not null, primary key (id));
create table character (id bigint generated by default as identity, avatar blob, created_at TIMESTAMP WITH TIME ZONE not null, description TEXT not null, is_global boolean not null, name varchar(100) not null, short_description TEXT not null, updated_at TIMESTAMP WITH TIME ZONE not null, default_llm_id bigint, user_id bigint not null, primary key (id));
create table dialogue (id bigint generated by default as identity, created_at TIMESTAMP WITH TIME ZONE not null, name varchar(255) not null, scene_description TEXT, status enum ('COMPLETED','FAILED') not null, updated_at TIMESTAMP WITH TIME ZONE not null, user_id bigint not null, primary key (id));
create table dialogue_character_config (character_id bigint not null, dialogue_id bigint not null, llm_id bigint not null, primary key (character_id, dialogue_id));
create table dialogue_message (id bigint generated by default as identity, content TEXT not null, turn_number integer not null, character_id bigint not null, dialogue_id bigint not null, primary key (id));
create table llm (id bigint generated by default as identity, name varchar(100) not null, openrouter_identifier varchar(100) not null, primary key (id));
alter table if exists app_user drop constraint if exists UK1j9d9a06i600gd43uu3km82jw;
alter table if exists app_user add constraint UK1j9d9a06i600gd43uu3km82jw unique (email);
alter table if exists character drop constraint if exists UK5yd1ld0gkcjrhiyohdgjacsih;
alter table if exists character add constraint UK5yd1ld0gkcjrhiyohdgjacsih unique (user_id, name);
alter table if exists character add constraint fk_default_llm foreign key (default_llm_id) references llm;
alter table if exists character add constraint FKs6n9v86pr9i642wijsckw9k0b foreign key (user_id) references app_user;
alter table if exists dialogue add constraint FKr5wm9k9uodxm45vb5dfkpe06k foreign key (user_id) references app_user;
alter table if exists dialogue_character_config add constraint FKpuscirj1k78t5sjj07a764e1g foreign key (character_id) references character;
alter table if exists dialogue_character_config add constraint FKqpo3eqaxl5ekacttdphvu9wnv foreign key (dialogue_id) references dialogue;
alter table if exists dialogue_character_config add constraint FKe1nrkkwocnapy0egs56ykt6gj foreign key (llm_id) references llm;
alter table if exists dialogue_message add constraint FK7hiufpiy4wcno2729ko0e6gfa foreign key (character_id) references character;
alter table if exists dialogue_message add constraint FKm8v18cdk2x31fysc54lc4vi4t foreign key (dialogue_id) references dialogue; 